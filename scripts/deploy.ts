import { createWalletClient, createPublicClient, http, parseEther } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { base } from 'viem/chains';

const DEPLOYER_PRIVATE_KEY = process.env.DEPLOYER_PRIVATE_KEY;

if (!DEPLOYER_PRIVATE_KEY) {
  console.error('‚ùå DEPLOYER_PRIVATE_KEY not found in environment');
  process.exit(1);
}

const contractBytecode = `0x608060405234801561000f575f80fd5b505f805460ff60a01b1933166001600160a81b03199091161781556001556108a08061003a5f395ff3fe60806040526004361061009d575f3560e01c806395ccea671161006257806395ccea67146102ab578063affed0e0146102ca578063d0e30db0146102df578063dd5967c3146102e7578063e1e158a514610303578063f2fde38b14610316575f80fd5b806312065fe0146101fb5780633f4ba83a1461021c5780635c975abb146102325780638456cb59146102615780638da5cb5b14610275575f80fd5b366101f7575f34116100f65760405162461bcd60e51b815260206004820152601d60248201527f416d6f756e74206d7573742062652067726561746572207468616e203000000060448201526064015b60405180910390fd5b68056bc75e2d631000003411156101475760405162461bcd60e51b815260206004820152601560248201527410589bdd99481b585e1a5b5d5b4819195c1bdcda5d605a1b60448201526064016100ed565b5f54600160a01b900460ff16156101955760405162461bcd60e51b815260206004820152601260248201527110dbdb9d1c9858dd081a5cc81c185d5cd95960721b60448201526064016100ed565b600180549081905f6101a6836107c0565b9091555050604080513481526110e6602082015290810182905242606082015233907fa7a2b0b10115a142011cfc36fac0a104817ab220232be004dd0a3e4b223dcbbb9060800160405180910390a2005b5f80fd5b348015610206575f80fd5b50475b6040519081526020015b60405180910390f35b348015610227575f80fd5b50610230610335565b005b34801561023d575f80fd5b505f5461025190600160a01b900460ff1681565b6040519015158152602001610213565b34801561026c575f80fd5b506102306103a0565b348015610280575f80fd5b505f54610293906001600160a01b031681565b6040516001600160a01b039091168152602001610213565b3480156102b6575f80fd5b506102306102c53660046107fb565b61040b565b3480156102d5575f80fd5b5061020960015481565b610230610566565b3480156102f2575f80fd5b5061020968056bc75e2d6310000081565b34801561030e575f80fd5b506102095f81565b348015610321575f80fd5b50610230610330366004610825565b6106f6565b5f546001600160a01b0316331461035e5760405162461bcd60e51b81526004016100ed90610847565b5f805460ff60a01b191690556040513381527f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa906020015b60405180910390a1565b5f546001600160a01b031633146103c95760405162461bcd60e51b81526004016100ed90610847565b5f805460ff60a01b1916600160a01b1790556040513381527f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a25890602001610396565b5f546001600160a01b031633146104345760405162461bcd60e51b81526004016100ed90610847565b5f81156104415781610443565b475b90504781111561048c5760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b60448201526064016100ed565b5f836001600160a01b0316826040515f6040518083038185875af1925050503d805f81146104d5576040519150601f19603f3d011682016040523d82523d5f602084013e6104da565b606091505b505090508061051d5760405162461bcd60e51b815260206004820152600f60248201526e151c985b9cd9995c8819985a5b1959608a1b60448201526064016100ed565b836001600160a01b03167f5fafa99d0643513820be26656b45130b01e1c03062e1266bf36f88cbd3bd96958360405161055891815260200190565b60405180910390a250505050565b5f54600160a01b900460ff16156105b45760405162461bcd60e51b815260206004820152601260248201527110dbdb9d1c9858dd081a5cc81c185d5cd95960721b60448201526064016100ed565b5f19600154036105f35760405162461bcd60e51b815260206004820152600a6024820152695265656e7472616e637960b01b60448201526064016100ed565b5f34116106425760405162461bcd60e51b815260206004820152601d60248201527f416d6f756e74206d7573742062652067726561746572207468616e203000000060448201526064016100ed565b68056bc75e2d631000003411156106935760405162461bcd60e51b815260206004820152601560248201527410589bdd99481b585e1a5b5d5b4819195c1bdcda5d605a1b60448201526064016100ed565b600180549081905f6106a4836107c0565b9091555050604080513481526110e6602082015290810182905242606082015233907fa7a2b0b10115a142011cfc36fac0a104817ab220232be004dd0a3e4b223dcbbb9060800160405180910390a250565b5f546001600160a01b0316331461071f5760405162461bcd60e51b81526004016100ed90610847565b6001600160a01b0381166107675760405162461bcd60e51b815260206004820152600f60248201526e496e76616c6964206164647265737360881b60448201526064016100ed565b5f80546040516001600160a01b03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a35f80546001600160a01b0319166001600160a01b0392909216919091179055565b5f600182016107dd57634e487b7160e01b5f52601160045260245ffd5b5060010190565b6001600160a01b03811681146107f8575f80fd5b50565b5f806040838503121561080c575f80fd5b8235610817816107e4565b946020939093013593505050565b5f60208284031215610835575f80fd5b8135610840816107e4565b9392505050565b6020808252600990820152682737ba1037bbb732b960b91b60408201526060019056fea26469706673582212207b40e3a3126a94da0187c68583548affb90ec836ae76376272c3556b82248b2d64736f6c63430008150033`;

const contractABI = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "name": "user", "type": "address" },
      { "indexed": false, "name": "amount", "type": "uint256" },
      { "indexed": false, "name": "destinationChainId", "type": "uint256" },
      { "indexed": false, "name": "nonce", "type": "uint256" },
      { "indexed": false, "name": "timestamp", "type": "uint256" }
    ],
    "name": "DepositRequested",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "deposit",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      { "name": "to", "type": "address" },
      { "name": "amount", "type": "uint256" }
    ],
    "name": "emergencyWithdraw",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "pause",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "unpause",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "owner",
    "outputs": [{ "name": "", "type": "address" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getBalance",
    "outputs": [{ "name": "", "type": "uint256" }],
    "stateMutability": "view",
    "type": "function"
  }
];

async function deploy() {
  console.log('üöÄ Deploying BaseBridge contract to Base mainnet...\n');

  const account = privateKeyToAccount(DEPLOYER_PRIVATE_KEY as `0x${string}`);
  console.log('üìç Deployer address:', account.address);

  const publicClient = createPublicClient({
    chain: base,
    transport: http('https://mainnet.base.org'),
  });

  const walletClient = createWalletClient({
    account,
    chain: base,
    transport: http('https://mainnet.base.org'),
  });

  const balance = await publicClient.getBalance({ address: account.address });
  console.log('üí∞ Balance:', (Number(balance) / 1e18).toFixed(6), 'ETH\n');

  if (balance < parseEther('0.0005')) {
    console.error('‚ùå Insufficient balance for deployment. Need at least 0.0005 ETH');
    process.exit(1);
  }

  console.log('üìù Deploying contract (NO MINIMUM DEPOSIT)...');
  
  const hash = await walletClient.deployContract({
    abi: contractABI,
    bytecode: contractBytecode as `0x${string}`,
  });

  console.log('‚è≥ Transaction hash:', hash);
  console.log('   View on BaseScan: https://basescan.org/tx/' + hash);

  console.log('\n‚è≥ Waiting for confirmation...');
  const receipt = await publicClient.waitForTransactionReceipt({ hash });

  console.log('\n‚úÖ Contract deployed successfully!');
  console.log('üìç Contract address:', receipt.contractAddress);
  console.log('   View on BaseScan: https://basescan.org/address/' + receipt.contractAddress);
  console.log('\nüéâ Deployment complete! Update BRIDGE_CONTRACT_ADDRESS in client/src/lib/contract.ts');
}

deploy().catch((err) => {
  console.error('‚ùå Deployment failed:', err.message);
  process.exit(1);
});
